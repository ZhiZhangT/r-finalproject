---
title: "finalgroupproject"
author: "Tee Zhi Zhang"
date: "2023-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Final Group Project

### Group: Marcus Wan, Tan Xue Feng, Tee Zhi Zhang

## Introduction of Data

-   Price of HDB Resale Flat Sales: <https://beta.data.gov.sg/collections/189/datasets/d_8b84c4ee58e3cfc0ece0d773c8ca6abc/view>

-   Price of HDB BTO Launches:

    <https://beta.data.gov.sg/datasets/d_2d493bdcc1d9a44828b6e71cb095b88d/view>Â 

```{r}

library(tidyverse)
library(dplyr)
library(lubridate)
```

## Data Cleaning and Preprocessing for Resale Flat Prices

-   Remove street name, lease commence date, flat model (marcus)

Our data set is split into 4 different csv files which contain data for different time periods. Let us read the data examine the columns and data types.

```{r}
resale_data_19901999 <- read.csv('resale_19901999.csv', header = TRUE, sep = ',', encoding = 'UTF-8')
resale_data_20002012 <- read.csv('resale_2000Feb2012.csv', header = TRUE, sep = ',', encoding = 'UTF-8')
resale_data_20122014 <- read.csv('resale_Mar2012toDec2014.csv', header = TRUE, sep = ',', encoding = 'UTF-8')
resale_data_2017 <- read.csv('resale_Jan2017onwards.csv', header = TRUE, sep = ',', encoding = 'UTF-8')

resale_data_19901999
resale_data_20002012
resale_data_20122014
resale_data_2017
```

Next, we notice that 3 of 4 dataframes have the same columns, we will try to merge these 3 data frames by stacking them on top vertically.

```{r}
resale_data_19902014 <- rbind(resale_data_19901999, resale_data_20002012, resale_data_20122014)

resale_data_19902014
summary(resale_data_19902014)
```

The last data frame has an extra column, which is the "**remaining_lease"** column. We can calculate this value for the rest of the data set, by calculating the number of years between the lease expiry date (by taking the lease_commencement date + 99, since all HDB flats have a 99 year lease) and the date of transaction.

```{r}
resale_data_19902014$remaining_lease <- resale_data_19902014$lease_commence_date + 99 - as.integer(substr(resale_data_19902014$month, start=1, stop=4))

resale_data_19902014
```

The "**remaining_lease"** column in the last data set has type \<chr\>, we will convert it to \<int\> for uniformity before merging.

```{r}
resale_data_2017$remaining_lease <- as.integer(substr(resale_data_2017$remaining_lease, start=1, stop=2))

resale_data_2017
```

We can then merge all 4 datasets into one uniform dataset.

```{r}
resale_data <- rbind(resale_data_19902014, resale_data_2017)
summary(resale_data)

arrange(resale_data, remaining_lease, desc=F)
```

Next, we can remove some of the columns which are irrelevant for our study.

```{r}
clean_resale_data <- resale_data %>%
  select(-flat_model)

clean_resale_data
```

```{r}
summary(clean_resale_data)
```

To facilitate more efficient memory usage, stronger data integrity and modelling exploration later on, we will convert columns with \<chr\> data types into factors, since they all represent categorical data.

For **"town"**:

```{r}
clean_resale_data$town <- as.factor(clean_resale_data$town)

count(clean_resale_data, clean_resale_data$town)
```

For **"flat_type"**:

```{r}
count(clean_resale_data, clean_resale_data$flat_type)

# Replace all occurrences of "MULTI GENERATION" in the "flat_type" column with "MULTI-GENERATION"
clean_resale_data$flat_type <- sub("MULTI GENERATION", "MULTI-GENERATION", clean_resale_data$flat_type)

clean_resale_data$flat_type <- as.factor(clean_resale_data$flat_type)
count(clean_resale_data, clean_resale_data$flat_type)
```

For **"storey_range"**:

```{r}
count(clean_resale_data, clean_resale_data$storey_range)

# Not sure how to handle the overlaps LMAO @marcus do you think we can fix these into categorical variables?
```

```{r}
summary(clean_resale_data)
```

## Exploratory Data Analysis for Resale Flat Prices

### Overall Time Series Analysis of Prices (marcus)

#testing git upload - marcus

### Distribution of Price by Flat Type (marcus)

### Distribution of Price by Town (zz)

-   Heat-map representation, over-time?

In order to get a mapped representation of all our data points, we needed to convert the addresses to latitude, longitude coordinates. We can do so by using geocoding services such as Google Maps', but this will be very costly as we have close to 900k address to encode. Thankfully, we found a mapping dataset on Kaggle: <https://www.kaggle.com/datasets/mylee2009/singapore-postal-code-mapper/> that allowed us to do this mapping.

Here, we read and renamed the column names to match the column names of our data frame and selected only the relevant columns, to prepare for inner joining.

```{r}
locations_df <- read_csv("sg_zipcode_mapper.csv")
locations_df
locations_df <- locations_df %>%
  rename("street_name" = "RD_name", "block" = "blk_no") %>%
  select(street_name, latitude, longtitude, block)
```

Next, we did an inner join to merge information about the coordinates on to our original dataframe.

Our initial results only showed 26k matched rows out of over 800k rows, which was puzzling for us. Hence we examined the location-mapping dataframe closer with *View(locations_df)* and found out that there were different naming conventions for the street names. Hence, we rectified that manually in the .csv files, and our matches increased to over 671k rows, which was sufficient.

```{r}

matched_rows <- inner_join(clean_resale_data, locations_df, by = c("street_name", "block"))
matched_rows$price_psm <- matched_rows$resale_price / matched_rows$floor_area_sqm

count(matched_rows, matched_rows$town)
matched_rows
```

```{r}
# We found and used a vector file that makes up Singapore's map.
singapore_map <- st_read("singapore-boundary.geojson")

# Next we did a ggplot with the Singapore map as the underlying background layer, with points positioned based on their lat-long coordinates, and colored by their price per square metre.
ggplot() +
  geom_sf(data = singapore_map) +
  coord_sf(crs = 4326, xlim = c(103.67, 104.0), ylim = c(1.26, 1.465), expand = FALSE) +
  geom_point(data = matched_rows, aes(x = longtitude, y = latitude,  color= price_psm), size = 0.5) +
  scale_color_gradient(low = "green", high = "red") +
  labs(title = "Singapore Map with Data Points") +
  theme_minimal()
```

### Distribution of Price by Remaining Lease Years (marcus)

-   Predict the future price of HDB for Remaining lease years of less than 40 (or whatever the lowest remaining lease years is now)

### Distribution of Price by Storey range of flat (marcus)

\

## Modelling and Prediction of future HDB Resale Prices (xf)

-   Linear regression for single variables

-   Linear regression for 2 variables

-   Linear regression for all variables

\

## How BTO Buyers can maximise returns (KIV)

-   Calculate returns based on:

    -   Number of years after minimum MOP

    -   Town

    -   Room Type
