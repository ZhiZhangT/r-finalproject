---
title: "finalgroupproject"
author: "Tee Zhi Zhang"
date: "2023-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Final Group Project

### Group: Marcus Wan, Tan Xue Feng, Tee Zhi Zhang

## Introduction of Data

-   Price of HDB Resale Flat Sales: <https://beta.data.gov.sg/collections/189/datasets/d_8b84c4ee58e3cfc0ece0d773c8ca6abc/view>

-   Price of HDB BTO Launches:

    <https://beta.data.gov.sg/datasets/d_2d493bdcc1d9a44828b6e71cb095b88d/view>Â 

```{r}

library(tidyverse)
library(dplyr)
library(lubridate)
```

## Data Cleaning and Preprocessing for Resale Flat Prices

-   Remove street name, lease commence date, flat model (marcus)

Our data set is split into 4 different csv files which contain data for different time periods. Let us read the data examine the columns and data types.

```{r}
resale_data_19901999 <- read.csv('resale_19901999.csv', header = TRUE, sep = ',', encoding = 'UTF-8')
resale_data_20002012 <- read.csv('resale_2000Feb2012.csv', header = TRUE, sep = ',', encoding = 'UTF-8')
resale_data_20122014 <- read.csv('resale_Mar2012toDec2014.csv', header = TRUE, sep = ',', encoding = 'UTF-8')
resale_data_2017 <- read.csv('resale_Jan2017onwards.csv', header = TRUE, sep = ',', encoding = 'UTF-8')

resale_data_19901999
resale_data_20002012
resale_data_20122014
resale_data_2017
```

Next, we notice that 3 of 4 dataframes have the same columns, we will try to merge these 3 data frames by stacking them on top vertically.

```{r}
resale_data_19902014 <- rbind(resale_data_19901999, resale_data_20002012, resale_data_20122014)

resale_data_19902014
summary(resale_data_19902014)
```

The last data frame has an extra column, which is the "**remaining_lease"** column. We can calculate this value for the rest of the data set, by calculating the number of years between the lease expiry date (by taking the lease_commencement date + 99, since all HDB flats have a 99 year lease) and the date of transaction.

```{r}
resale_data_19902014$remaining_lease <- resale_data_19902014$lease_commence_date + 99 - as.integer(substr(resale_data_19902014$month, start=1, stop=4))

resale_data_19902014
```

The "**remaining_lease"** column in the last data set has type \<chr\>, we will convert it to \<int\> for uniformity before merging.

```{r}
resale_data_2017$remaining_lease <- as.integer(substr(resale_data_2017$remaining_lease, start=1, stop=2))

resale_data_2017
```

We can then merge all 4 datasets into one uniform dataset.

```{r}
resale_data <- rbind(resale_data_19902014, resale_data_2017)
summary(resale_data)

arrange(resale_data, remaining_lease, desc=F)
```

Next, we can remove some of the columns which are irrelevant for our study.

```{r}
clean_resale_data <- resale_data %>%
  select(-flat_model)

clean_resale_data
```

```{r}
summary(clean_resale_data)
```

To facilitate more efficient memory usage, stronger data integrity and modelling exploration later on, we will convert columns with \<chr\> data types into factors, since they all represent categorical data.

For **"town"**:

```{r}
clean_resale_data$town <- as.factor(clean_resale_data$town)

count(clean_resale_data, clean_resale_data$town)
```

For **"flat_type"**:

```{r}
count(clean_resale_data, clean_resale_data$flat_type)

# Replace all occurrences of "MULTI GENERATION" in the "flat_type" column with "MULTI-GENERATION"
clean_resale_data$flat_type <- sub("MULTI GENERATION", "MULTI-GENERATION", clean_resale_data$flat_type)

clean_resale_data$flat_type <- as.factor(clean_resale_data$flat_type)
count(clean_resale_data, clean_resale_data$flat_type)
```

For **"storey_range"**:

```{r}
count(clean_resale_data, clean_resale_data$storey_range)

# Not sure how to handle the overlaps LMAO @marcus do you think we can fix these into categorical variables?

# i try. imma just average it

# Since the storey data is provided in a range, we shall determine the average storey and use that for analysis.
# Create a new column with the average storey
clean_resale_data <- clean_resale_data %>%
  mutate(storey_min = as.numeric(sub(" TO .*", "", storey_range)),
         storey_max = as.numeric(sub(".* TO ", "", storey_range)),
         avg_storey = (storey_min + storey_max) / 2)

```

Changing the date of sale to the correct date format,
```{r}
clean_resale_data$month <- as.Date(paste(clean_resale_data$month, "01", sep = "-"), format = "%Y-%m-%d")
```

```{r}
summary(clean_resale_data)
```

## Exploratory Data Analysis for Resale Flat Prices

### Overall Time Series Analysis of Prices (marcus)
In order to have a better understanding of how the prices of HDB units changed over time, we shall conduct a time series analysis of prices.
```{r}
#library(tsibble)
#hdb_tsibble <- clean_resale_data %>%
#  as_tsibble(index = month)
#summary(hdb_tsibble)
ggplot(clean_resale_data, aes(x = month, y = resale_price)) +
  geom_line()
```
The gap from 2015 to 2017 is due to the lack of data from that period.

## Do we need to analyse this? eg, find some govt cooling measure to explain the drop in price in some years etc?

### Distribution of Price by Flat Type (marcus)
We can also analyse the data to analyse the prices of the different types of HDB flats.
```{r}
summary_stats <- clean_resale_data %>%
  group_by(flat_type) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
summary_stats
```

Visualising using Box Plot,
```{r}
ggplot(clean_resale_data, aes(x = flat_type, y = resale_price)) +
  geom_boxplot() +
  labs(title = "Distribution of Prices by Flat Type", y = "Resale Price (SGD)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Visualising using Bar Plot,
```{r}
ggplot(summary_stats, aes(x = flat_type, y = Mean_Price)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average Price by Flat Type", y = "Average Resale Price (SGD)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::comma)

```

Visualizing using Histogram,
```{r}
ggplot(clean_resale_data, aes(x = resale_price)) +
  geom_histogram(binwidth = 50000, fill = "green", color = "black") +
  facet_wrap(~flat_type, scales = "free") +
  labs(title = "Price Distribution by Flat Type", x = "Resale Price (SGD)") +
  scale_x_continuous(labels = scales::comma)

```
As noticed in the time-series analysis, the prices of HDB flats changed greatly over time. It might thus be more useful to compare the price of various flat types over a shorter time frame. We chose 2017 for this as this is the latest data.
```{r}
clean_resale_data_2017 <- clean_resale_data %>%
  filter(year(month) == 2017)
```

```{r}
summary_stats_2017 <- clean_resale_data_2017 %>%
  group_by(flat_type) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
summary_stats_2017
```

Visualising using Box Plot,
```{r}
ggplot(clean_resale_data_2017, aes(x = flat_type, y = resale_price)) +
  geom_boxplot() +
  labs(title = "Distribution of Prices by Flat Type", y = "Resale Price (SGD)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Visualising using Bar Plot,
```{r}
ggplot(summary_stats_2017, aes(x = flat_type, y = Mean_Price)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average Price by Flat Type", y = "Average Resale Price (SGD)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::comma)

```
Visualizing using Histogram,
```{r}
ggplot(clean_resale_data_2017, aes(x = resale_price)) +
  geom_histogram(binwidth = 50000, fill = "green", color = "black") +
  facet_wrap(~flat_type, scales = "free") +
  labs(title = "Price Distribution by Flat Type", x = "Resale Price (SGD)") +
  scale_x_continuous(labels = scales::comma)

```


### Distribution of Price by Town (zz)

-   Heat-map representation, over-time?

In order to get a mapped representation of all our data points, we needed to convert the addresses to latitude, longitude coordinates. We can do so by using geocoding services such as Google Maps', but this will be very costly as we have close to 900k address to encode. Thankfully, we found a mapping dataset on Kaggle: <https://www.kaggle.com/datasets/mylee2009/singapore-postal-code-mapper/> that allowed us to do this mapping.

Here, we read and renamed the column names to match the column names of our data frame and selected only the relevant columns, to prepare for inner joining.

```{r}
locations_df <- read_csv("sg_zipcode_mapper.csv")
locations_df
locations_df <- locations_df %>%
  rename("street_name" = "RD_name", "block" = "blk_no") %>%
  select(street_name, latitude, longtitude, block)
```

Next, we did an inner join to merge information about the coordinates on to our original dataframe.

Our initial results only showed 26k matched rows out of over 800k rows, which was puzzling for us. Hence we examined the location-mapping dataframe closer with *View(locations_df)* and found out that there were different naming conventions for the street names. Hence, we rectified that manually in the .csv files, and our matches increased to over 671k rows, which was sufficient.

```{r}

matched_rows <- inner_join(clean_resale_data, locations_df, by = c("street_name", "block"))
matched_rows$price_psm <- matched_rows$resale_price / matched_rows$floor_area_sqm

count(matched_rows, matched_rows$town)
matched_rows
```

```{r}
# We found and used a vector file that makes up Singapore's map.
singapore_map <- st_read("singapore-boundary.geojson")

# Next we did a ggplot with the Singapore map as the underlying background layer, with points positioned based on their lat-long coordinates, and colored by their price per square metre.
ggplot() +
  geom_sf(data = singapore_map) +
  coord_sf(crs = 4326, xlim = c(103.67, 104.0), ylim = c(1.26, 1.465), expand = FALSE) +
  geom_point(data = matched_rows, aes(x = longtitude, y = latitude,  color= price_psm), size = 0.5) +
  scale_color_gradient(low = "green", high = "red") +
  labs(title = "Singapore Map with Data Points") +
  theme_minimal()
```

### Distribution of Price by Remaining Lease Years (marcus)
As HDB units is a form of public housing, all HDB units sold to Singaporeans have a 99 year lease attached to them. Once the period of the lease is up, the unit must be returned to the government without compensation (ie, its value will be 0 when the lease hits 0 years). 

Thus, one factor that affects the price of a HDB unit is the number of years of lease left. We shall analyse this here.

```{r}
remaining_lease_summary_stats <- clean_resale_data %>%
  group_by(remaining_lease) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
remaining_lease_summary_stats
```
Scatter plot
```{r}
ggplot(clean_resale_data, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  labs(title = "Scatterplot of Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")
```
Using a regression model,
```{r}
lm_model <- lm(resale_price ~ remaining_lease, data = clean_resale_data)

# Summary of the regression model
summary(lm_model)
```
Visualsing the regression line,
```{r}
ggplot(clean_resale_data, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Regression Line: Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")

```
#This data is too dirty. 
In order to ensure that we see a clearer relationship between the price and the remaining lease, let's only use data from 2017.
```{r}
remaining_lease_summary_stats_2017 <- clean_resale_data_2017 %>%
  group_by(remaining_lease) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
remaining_lease_summary_stats_2017
```
Scatter plot
```{r}
ggplot(clean_resale_data_2017, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  labs(title = "Scatterplot of Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")
```
Using a regression model,
```{r}
lm_model_2017 <- lm(resale_price ~ remaining_lease, data = clean_resale_data_2017)

# Summary of the regression model
summary(lm_model_2017)
```
Visualsing the regression line,
```{r}
ggplot(clean_resale_data_2017, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Regression Line: Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")
```
We can see that there is a positive relationship between remaining lease and the resale price.

### Predict the future price of HDB for Remaining lease years of less than 40 (or whatever the lowest remaining lease years is now)
From the sales data we are utilising, we can see that the lowest remaining lease value is 42 years. This is because it has only been around 60 years since the first HDB unit was sold. As such, til date, there has been no unit that was returned to the government. We know that the price of these units will be zero when the lease runs out. As such, one point of interest we can analyse would be whether this fact is taken into account by the resale market.

Let's create an additional data point for when resale price = 0 when remaining lease = 0. We shall create a new weighted regression model with increased weight for the (0, 0) data point.

```{r}
additional_point <- data.frame(
  remaining_lease = 0,
  resale_price = 0
)
clean_resale_data_2017_00 <- bind_rows(clean_resale_data_2017, additional_point)

weights <- ifelse(clean_resale_data_2017_00$remaining_lease == 0, 165041, 1)

weighted_lm_model <- lm(resale_price ~ remaining_lease, data = clean_resale_data_2017_00, weights = weights)

summary(weighted_lm_model)

```
Visualizing on scatter plot,
```{r}
# Scatterplot of data
plot(clean_resale_data_2017_00$remaining_lease, clean_resale_data_2017_00$resale_price, pch = 19, col = "black", main = "Weighted Regression Line: Resale Prices vs. Remaining Lease", xlab = "Remaining Lease (Years)", ylab = "Resale Price (SGD)")

# Add the fitted line from the regression model
abline(weighted_lm_model, col = "red")
```


### Distribution of Price by Storey range of flat (marcus)
Let's also explore how the storey of the unit affects the price
```{r}
# Since there are too many storeys to display on a barplot, let's create bins
bin_width <- 10 
clean_resale_data_bins <- clean_resale_data %>%
  mutate(storey_bin = cut(avg_storey, breaks = seq(0, max(avg_storey), by = bin_width), right = FALSE))

storey_bin_summary_stats <- clean_resale_data_bins %>%
  group_by(storey_bin) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
storey_bin_summary_stats 
```
Visualising using Box Plot,
```{r}
ggplot(clean_resale_data_bins, aes(x = storey_bin, y = resale_price)) +
  geom_boxplot() +
  labs(title = "Distribution of Prices by Storey Range", y = "Resale Price (SGD)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Visualising using a barplot,
```{r}
ggplot(storey_bin_summary_stats, aes(x = storey_bin, y = Mean_Price)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average Price by Storey Range", x = "Storey Range", y = "Average Resale Price (SGD)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Visualising using a histogram,
```{r}
ggplot(clean_resale_data_bins, aes(x = resale_price)) +
  geom_histogram(binwidth = 50000, fill = "green", color = "black") +
  facet_wrap(~storey_bin, scales = "free") +
  labs(title = "Price Distribution by Storey Range", x = "Resale Price (SGD)")

```


## Modelling and Prediction of future HDB Resale Prices (xf)

-   Linear regression for single variables

-   Linear regression for 2 variables

-   Linear regression for all variables

\

## How BTO Buyers can maximise returns (KIV)

-   Calculate returns based on:

    -   Number of years after minimum MOP

    -   Town

    -   Room Type
