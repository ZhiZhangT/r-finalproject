---
title: "finalgroupproject"
author: "Tee Zhi Zhang"
date: "2023-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Final Group Project

### Group: Marcus Wan, Tan Xue Feng, Tee Zhi Zhang


Singapore's public housing system, administered by the Housing and Development Board (HDB), provides affordable and quality homes for the majority of the population. HDB flats are sold through two main schemes: the Build-To-Order (BTO) scheme, where buyers apply for new flats that are built upon sufficient demand, and the resale market, where buyers purchase existing flats from previous owners. Both schemes are subject to eligibility criteria, subsidies, and regulations that aim to ensure a fair and efficient allocation of housing resources. 

In this report, we will explore the data and trends of the HDB prices in Singapore, covering both the resale and BTO markets. We will analyse the factors that influence the resale value of HDB flats, such as location, flat type, lease duration, and floor area. We will also explore how these various factors relate to each other and highlight some prevailing trends.

## Introduction of Data

Here is where we got the data used in this analysis from:

-   Price of HDB Resale Flat Sales: <https://beta.data.gov.sg/collections/189/datasets/d_8b84c4ee58e3cfc0ece0d773c8ca6abc/view>

-   Price of HDB BTO Launches:

    <https://beta.data.gov.sg/datasets/d_2d493bdcc1d9a44828b6e71cb095b88d/view>Â 

Here are a list of the libraries used
```{r}

library(tidyverse)
library(dplyr)
library(lubridate)
library(sf)
library(gganimate)
library(animation)
library(gifski)
```

## Data Cleaning and Preprocessing for Resale Flat Prices

Our data set is split into 5 different csv files which contain data for different time periods. Let us read the data examine the columns and data types.

```{r}
resale_data_19901999 <- read.csv('resale_19901999.csv', header = TRUE, sep = ',', encoding = 'UTF-8')
resale_data_20002012 <- read.csv('resale_2000Feb2012.csv', header = TRUE, sep = ',', encoding = 'UTF-8')
resale_data_20122014 <- read.csv('resale_Mar2012toDec2014.csv', header = TRUE, sep = ',', encoding = 'UTF-8')
resale_data_20152016 <- read.csv('resale_20152016.csv', header=TRUE, sep = ',', encoding = 'UTF-8')
resale_data_2017 <- read.csv('resale_Jan2017onwards.csv', header = TRUE, sep = ',', encoding = 'UTF-8')

resale_data_19901999
resale_data_20002012
resale_data_20122014
resale_data_20152016
resale_data_2017
```

Next, we notice that 3 of 5 dataframes have the same columns, we will try to merge these 3 data frames by stacking them on top vertically.

```{r}
resale_data_19902014 <- rbind(resale_data_19901999, resale_data_20002012, resale_data_20122014)

resale_data_19902014
summary(resale_data_19902014)
```

The last data frame has an extra column, which is the "**remaining_lease"** column. We can calculate this value for the rest of the data set, by calculating the number of years between the lease expiry date (by taking the lease_commencement date + 99, since all HDB flats have a 99 year lease) and the date of transaction.

```{r}
resale_data_19902014$remaining_lease <- resale_data_19902014$lease_commence_date + 99 - as.integer(substr(resale_data_19902014$month, start=1, stop=4))

resale_data_19902014
```

The "**remaining_lease"** column in the last 2 data set has type \<chr\>, we will convert it to \<int\> for uniformity before merging.

```{r}
resale_data_20152016$remaining_lease <- as.integer(substr(resale_data_20152016$remaining_lease, start=1, stop=2))

resale_data_2017$remaining_lease <- as.integer(substr(resale_data_2017$remaining_lease, start=1, stop=2))

resale_data_20152016
resale_data_2017
```

We can then merge all 5 datasets into one uniform dataset.

```{r}
resale_data <- rbind(resale_data_19902014, resale_data_20152016, resale_data_2017)
summary(resale_data)

arrange(resale_data, remaining_lease, desc=F)
```

Next, we can remove some of the columns which are irrelevant for our study.

```{r}
clean_resale_data <- resale_data %>%
  select(-flat_model)

clean_resale_data
```

```{r}
summary(clean_resale_data)
```

To facilitate more efficient memory usage, stronger data integrity and modelling exploration later on, we will convert columns with \<chr\> data types into factors, since they all represent categorical data.

For **"town"**:

```{r}
clean_resale_data$town <- as.factor(clean_resale_data$town)

count(clean_resale_data, clean_resale_data$town)
```

For **"flat_type"**:

```{r}
count(clean_resale_data, clean_resale_data$flat_type)

# Replace all occurrences of "MULTI GENERATION" in the "flat_type" column with "MULTI-GENERATION"
clean_resale_data$flat_type <- sub("MULTI GENERATION", "MULTI-GENERATION", clean_resale_data$flat_type)

clean_resale_data$flat_type <- as.factor(clean_resale_data$flat_type)
count(clean_resale_data, clean_resale_data$flat_type)
```

For **"storey_range"**:
Since the storey data is provided in a range, we shall determine the average storey and use that for analysis.
```{r}
count(clean_resale_data, clean_resale_data$storey_range)

clean_resale_data <- clean_resale_data %>%
  mutate(storey_min = as.numeric(sub(" TO .*", "", storey_range)),
         storey_max = as.numeric(sub(".* TO ", "", storey_range)),
         avg_storey = (storey_min + storey_max) / 2)

```

Changing the date of sale to the correct date format,

```{r}
clean_resale_data$month <- as.Date(paste(clean_resale_data$month, "01", sep = "-"), format = "%Y-%m-%d")
```

```{r}
summary(clean_resale_data)
```

## Exploratory Data Analysis for Resale Flat Prices

### Overall Time Series Analysis of Prices

In order to have a better understanding of how the prices of HDB units in general changed over time, we shall conduct a time series analysis of prices.

```{r}
grouped_clean_resale_data <- clean_resale_data %>%
  group_by(month) %>%
  summarize(avg_price = mean(resale_price, na.rm = TRUE))

ggplot(grouped_clean_resale_data, aes(x = month, y = avg_price)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Resale Price Over Time", x = "Time", y = "Resale Price")
```
We can see that there is a general rise in resale prices of HDB flats over time. The fall in prices observed in 1997 could be due to the asian financial crisis which negatively impacted the Singapore economy. The fall in prices in 2013 could be due to the introduction of cooling measures by the Singapore government. These included policies such as reducing the mortgage servicing ratio, the maximum loan term, and the eligibility of permanent residents to buy resale flats.

### Distribution of Price by Flat Type

We can also analyse the data to determine the prices of the different types of HDB flats.

```{r}
summary_stats <- clean_resale_data %>%
  group_by(flat_type) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
summary_stats
```

Visualising using Box Plot,

```{r}
ggplot(clean_resale_data, aes(x = flat_type, y = resale_price)) +
  geom_boxplot() +
  labs(title = "Distribution of Prices by Flat Type", y = "Resale Price (SGD)", x = "flat type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
From the box plot, we can see the median prices as well as the first and third quartile. We do notice that, as the housing type gets more expensive, the variance of the prices for that housing type also increases. 

Visualising using Bar Plot,
```{r}
ggplot(summary_stats, aes(x = flat_type, y = Mean_Price)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average Price by Flat Type", y = "Average Resale Price (SGD)", x = "flat type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::comma)

```
We also do notice a general increase in the mean prices as the flat type gets better.

Visualizing using Histogram,
```{r}
ggplot(clean_resale_data, aes(x = resale_price)) +
  geom_histogram(binwidth = 50000, fill = "green", color = "black") +
  facet_wrap(~flat_type, scales = "free") +
  labs(title = "Price Distribution by Flat Type", x = "Resale Price (SGD)", x = "flat type") +
  scale_x_continuous(labels = scales::comma)

```
Looking at the above histogram, we notice an anomaly in the price distribution of 2 room flats, with two peaks at around SGD 120,000 and SGD 250,000. Upon further research, we found out that two room flats come in two types: Type 1 and Type 2. The  more affordable type 1 flats are generally catered towards lower income households. This separation between type 1 and 2 two room flats is not delineated in our dataset. 
https://www.hdb.gov.sg/cs/infoweb/-/media/doc/CCG/04022021-BTO-Annexes/Annex-A2-Feb-2021-BTO.pdf 


As noticed in the time-series analysis, the prices of HDB flats changed greatly over time. It might thus be more useful to compare the price of various flat types over a shorter time frame. We chose data from 2022 for this as this is the latest full-year-data we have.

```{r}
clean_resale_data_2022 <- clean_resale_data %>%
  filter(year(month) == 2022)
```

```{r}
summary_stats_2022 <- clean_resale_data_2022 %>%
  group_by(flat_type) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
summary_stats_2022
```

Visualising using Box Plot,

```{r}
ggplot(clean_resale_data_2022, aes(x = flat_type, y = resale_price)) +
  geom_boxplot() +
  labs(title = "Distribution of Prices by Flat Type", y = "Resale Price (SGD)", x = "flat type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::comma)
```

Visualising using Bar Plot,

```{r}
ggplot(summary_stats_2022, aes(x = flat_type, y = Mean_Price)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average Price by Flat Type", y = "Average Resale Price (SGD)", x = "flat type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::comma)

```

Visualizing using Histogram,

```{r}
ggplot(clean_resale_data_2022, aes(x = resale_price)) +
  geom_histogram(binwidth = 50000, fill = "green", color = "black") +
  facet_wrap(~flat_type, scales = "free") +
  labs(title = "Price Distribution by Flat Type", x = "Resale Price (SGD)", x = "flat type") +
  scale_x_continuous(labels = scales::comma)

```
?????????Comparing the above three plots for 2022 against their corresponding plots for the entire time period, we see that there

Let's also analyse how the resale prices of the various flat types changed over time
```{r}
ggplot() +
  geom_smooth(data = clean_resale_data, aes(x = month, y = resale_price, color=flat_type)) +
  scale_y_continuous(labels = scales::comma) +
  theme(axis.text.x = element_blank()) +
  labs(title = "Resale Price Over Time for Various Flat Types", x = "Time", y = "Resale Price")
```
We can see that each town generally follows the overall trend of Singapore's HDB resale prices. The data for Multi-Generation flats have greater fluctuations and variance but that is likely due to the much lower data points regarding Multi-Generation Flat sales due to its rarity.


### Distribution of Price by Town 

In order to get a mapped representation of all our data points, we needed to convert the addresses to latitude, longitude coordinates. We can do so by using geocoding services such as Google Maps', but this will be very costly as we have close to 900k address to encode. Thankfully, we found a mapping dataset on Kaggle: <https://www.kaggle.com/datasets/mylee2009/singapore-postal-code-mapper/> that allowed us to do this mapping.

Here, we read and renamed the column names to match the column names of our data frame and selected only the relevant columns, to prepare for inner joining.

```{r}
locations_df <- read_csv("sg_zipcode_mapper.csv")
locations_df
locations_df <- locations_df %>%
  rename("street_name" = "RD_name", "block" = "blk_no") %>%
  select(street_name, latitude, longtitude, block)
```

Next, we did an inner join to merge information about the coordinates on to our original dataframe.

Our initial results only showed 26k matched rows out of over 900k rows, which was puzzling for us. Hence we examined the location-mapping dataframe closer with *View(locations_df)* and found out that there were different naming conventions for the street names. Hence, we rectified that manually in the .csv files, and our matches increased to over 700k rows, which was sufficient.

```{r}
clean_resale_data
```

```{r}

matched_rows <- inner_join(clean_resale_data, locations_df, by = c("street_name", "block"))
matched_rows$price_psm <- matched_rows$resale_price / matched_rows$floor_area_sqm

count(matched_rows, matched_rows$town)
matched_rows
```

```{r}
# We found and used a vector file that makes up Singapore's map.
singapore_map <- st_read("singapore-boundary.geojson")

# Adding labels of each town to the map:
labels <- data.frame(
  longitude = c(103.847641, 103.932381, 103.848747, 103.818588, 103.7630947, 103.7763724, 103.84622192382812, 103.74625396728516, 103.76336669921875, 103.8818588256836, 103.89112091064453, 103.74030303955078, 103.70392608642578, 103.85871887207031, 103.90089416503906, 103.95957946777344, 103.90625762939453, 103.7967529296875, 103.82157135009766, 103.89371490478516),
  latitude = c(1.371730 ,1.324660, 1.350400, 1.282010, 1.3779175, 1.3546901, 1.2873523235321045, 1.3849343061447144, 1.3065141439437866, 1.3184434175491333, 1.3708921670913696, 1.3372708559036255, 1.3410615921020508, 1.3161046504974365, 1.3020074367523193, 1.3678756952285767, 1.4028823375701904, 1.3026505708694458, 1.4498075246810913, 1.3933453559875488), 
  label = c("Ang Mo Kio", "Bedok", "Bishan", "Bukit Merah", "Bukit Panjang", "Bukit Timah", "Central", "Choa Chu Kang", "Clementi", "Geylang", "Hougang", "Jurong East", "Jurong West", "Kallang", "Marine Parade", "Pasir Ris", "Punggol", "Queenstown", "Sembawang", "Sengkang"
))

# Next we did a ggplot with the Singapore map as the underlying background layer, with points positioned based on their lat-long coordinates, and colored by their price per square metre.

base_plot <- ggplot() +
  geom_sf(data = singapore_map) +
  coord_sf(crs = 4326, xlim = c(103.67, 104.0), ylim = c(1.26, 1.465), expand = FALSE) +
  geom_point(data = matched_rows, aes(x = longtitude, y = latitude,  color= price_psm), size = 0.5) +
  scale_color_gradient(low = "green", high = "red") +
  geom_text(data = labels, aes(x = longitude, y = latitude, label = label), size = 3) +
  labs(title = "Singapore Map with Data Points") +
  theme_minimal()

base_plot
```

```{r}
animation <- base_plot +
  transition_time(month) +
  labs(title = "Month: {frame_time}")

animate(animation, duration = 10, fps = 6, width = 600, height = 300, renderer = gifski_renderer())
```

Here, we can see that property prices have been increasing steadily since the 1990s, starting from towns in the South like Bukit Merah and Central, and then the increase gradually expanded to other towns like Ang Mo Kio, Punggol and Bishan.

Next, let us explore the number of transactions across towns:

```{r}
monthly_count <- clean_resale_data %>%
  group_by(month) %>%
  summarize(Count = n()) %>%
  arrange(Count, DESC=T)

monthly_count

ggplot(monthly_count, aes(x = month, y = Count)) +
  geom_line() +
  labs(
    title = "Number of Transactions Over Time",
    x = "Month",
    y = "Transaction Count"
  )
```

From this, we observe that there is a large spike in the number of transactions in the years 1998-2000, where Singapore experienced a property "boom" period; and we also can see that the build-up and gradual stabilization took around 3-4 years each. There are smaller peaks in the years of 2010 and 2021 as well. Overall, we can see that the trend follows a wave pattern where there are repeated periods of ups and downs that span around 10-15 years each.

Adding the resale price data to the above graph,
```{r}
coeff = 40
ggplot(grouped_clean_resale_data, aes(x = month, y = avg_price)) +
  geom_line(color = "blue") +
  geom_line(data=monthly_count, aes(x = month, y = Count*coeff), color="black") +
  scale_y_continuous("Resale Price", labels = scales::comma ) +
  labs(title = "Resale Price Over Time", x = "Time")
```
We see some interesting phenomenon comparing the transaction count and the resale price data. We can see that in 1997, there is simultaneously a sharp drop in housing resale prices and a large increase in housing sale transactions. This is likely due to the retrenchment resulting from the asian financial crisis which caused a large number of people to sell off their HDB houses. This increased supply of HDB units in the market likely resulted in the sharp fall in price that we saw above. 

On the other hand, we can see a sharp fall in sales transaction count in early 2020 likely due to the Covid pandemic lockdowns preventing people from selling their HDB houses. This reduction in supply in turn drove prices up. 

```{r fig.width=10, fig.height=6}

ggplot(data = clean_resale_data) +
  geom_bar(aes(x = month, color=town))
  facet_wrap(clean_resale_data$town) +
  labs(title = "Number of Transactions Over Time",
       x = "Year-Month",
       y = "Transaction Count") +
  theme(legend.key.size = unit(1, "lines"))
```

```{r}
monthly_count <- clean_resale_data %>%
  group_by(month, town) %>%
  summarize(Count = n()) %>%
  arrange(Count, DESC=T)

monthly_count

ggplot(monthly_count, aes(x = month, y = Count, color=town)) +
  geom_line() +
  labs(
    title = "Number of Transactions Over Time",
    x = "Month",
    y = "Transaction Count"
  )
```

We can observe that the peak in 1998-2000 comprised of all-time high number of HDB resales happening in Bedok, Hougang, Pasir Ris, Jurong West, Tampines, Yishun; while the peak in 2010 can be attributed to the towns of Jurong West, Woodlands, Yishun, Bedok and Clementi. The most recent peak in 2022 can be mainly attributed to Yishun, Woodlands, Choa Chu Kang, Tampines and Jurong West.

Next, let's explore how the resale prices vary across HDB Towns.

We first see the overall resale prices trend in Singapore:

```{r}
ggplot(data = clean_resale_data, aes(x=month, y=resale_price)) +
  geom_point() +
  geom_smooth() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Resale Price Over Time", x = "Time", y = "Resale Price")

```

Next, we look at the trend in each HDB Town:

```{r fig.width=10, fig.height=6}
ggplot() +
  geom_smooth(data = clean_resale_data, aes(x = month, y = resale_price, color=town)) +
  facet_wrap(clean_resale_data$town) +
  scale_y_continuous(labels = scales::comma) +
  theme(axis.text.x = element_blank()) +
  labs(title = "Resale Price Over Time for Various Towns", x = "Time", y = "Resale Price")
```

```{r fig.width=10, fig.height=6}
ggplot() +
  geom_smooth(data = clean_resale_data, aes(x = month, y = resale_price, color=town)) +
  scale_y_continuous(labels = scales::comma) +
  theme(axis.text.x = element_blank()) +
  labs(title = "Resale Price Over Time for Various Towns", x = "Time", y = "Resale Price")
```

We can see that each town generally follows the overall trend of Singapore's HDB resale prices: with a steady increase over time but with periodic ups and downs in property prices. It can be noted that the peak and trendline for property prices typically trail those for the number of transactions by 1-2 years, shedding light on Singapore's property market behavior.

There is a lack of data for Lim Chu Kang town because in Lim Chu Kang, there was only a small public housing area known as Neo Tiew Estate (or Lim Chu Kang Rural Centre). The whole area was en-bloc in 2002, with the residents shifted to Jurong West. The estate was vacated since then, and is currently used for FIBUA (Fighting in Built-Up Areas) trainings by the Singapore Armed Forces (SAF). Hence, there is little to no transactions happening in Lim Chu Kang.

On the other hand, being a relatively new estate opened in 2003, we only have data from Punggol town halfway through our analysis period.

```{r}
summary_town <- clean_resale_data %>%
  group_by(town) %>%
  summarise(Mean_Price = mean(resale_price))

ggplot(data = summary_town, aes(x = town, y= Mean_Price)) +
  geom_bar(stat = "identity", fill="blue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Resale Price for Various Towns", x = "Town", y = "Mean Resale Price")
```

```{r fig.width=10, fig.height=8}
# Consider only the most recent data, after 2020: 
filtered_data <- clean_resale_data %>%
  filter(year(month) >= 2020)

ggplot() +
  geom_boxplot(data = filtered_data, aes(y = resale_price)) +
  facet_wrap(filtered_data$town)
```

Here, we can get a bird's eye view of the relative pricing of each town's HDB properties through the median resale price, 1st and 3rd quartile price and the minimum/ maximum prices.

You would have to pay a premium for flats in towns like Bishan, Bukit Merah, Bukit Timah, Central Area, Queenstown and Toa Payoh with median prices of around \$750K; primarily due to their locations and proximity to workplaces and places of attraction. On the other end, flats in towns like Choa Chu Kang, Bukit Panjang, Sembawang, Yishun and Pasir Ris are more affordable with median prices of around \$400K.

### Distribution of Price by Remaining Lease Years 

As HDB units is a form of public housing, all HDB units sold to Singaporeans have a 99 year lease attached to them. Once the period of the lease is up, the unit must be returned to the government without compensation (ie, its value will be 0 when the lease hits 0 years).

Thus, one factor that affects the price of a HDB unit is the number of years of lease left. We shall analyse this here.

```{r}
remaining_lease_summary_stats <- clean_resale_data %>%
  group_by(remaining_lease) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
remaining_lease_summary_stats
```

Let us begin by plotting the resale price against the remaining lease
```{r}
ggplot(clean_resale_data, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")
```

From this scatter plot, we noticed that the data is rather noisy and no clear trend can be determined. One reason for this is that the data we use ranges over many years and, as seen above, the resale price varies drastically over the years. Thus, let us only consider more recent resale data, from 2020 onwards.

```{r}
clean_resale_data_2020_onwards <- clean_resale_data %>%
  filter(year(month) >= 2020)

remaining_lease_summary_stats_2020_onwards <- clean_resale_data_2020_onwards %>%
  group_by(remaining_lease) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
remaining_lease_summary_stats_2020_onwards
```

```{r}
ggplot(clean_resale_data_2020_onwards, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")
```
Filtering the data to analyse only those within a shorter time period gave us a slightly clearer trend regarding the relationship between remaining lease and resale price.

In general, we see that the resale price decreases as the remaining lease decreases. However, we notice that there is a noticeable rise in resale price as the remaining lease falls from around 92 to 87 years. One reason for this is that HDB flats with over 90 years of lease would be rather new and thus more likely to be located in new towns. As these new towns mature, they become more attractive places to live in, resulting in the rise in resale price that we see. 

Using a regression model,

```{r}
lm_model_2020 <- lm(resale_price ~ remaining_lease, data = clean_resale_data_2020_onwards)

# Summary of the regression model
summary(lm_model_2020)
```

Visualizing the regression line, #remove

```{r}
ggplot(clean_resale_data_2020_onwards, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Regression Line: Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")
```
logistic regression
```{r}

ggplot(clean_resale_data_2020_onwards, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  stat_smooth(method="glm", color="green", se=FALSE) +
  labs(title = "Regression Line: Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")
```

We can see that there is a positive relationship between remaining lease and the resale price.

### Predict the future price of HDB for Remaining lease years of less than 40 (or whatever the lowest remaining lease years is now)

From the sales data we are utilising, we can see that the lowest remaining lease value is 42 years. This is because it has only been around 60 years since the first HDB unit was sold. As such, til date, there has been no unit that was returned to the government. We know that the price of these units will be zero when the lease runs out. As such, one point of interest we can analyse would be whether this fact is taken into account by the resale market.

Let's create an additional data point for when resale price = 0 when remaining lease = 0. We shall create a new weighted regression model with increased weight for the (0, 0) data point.

```{r}
additional_point <- data.frame(
  remaining_lease = 0,
  resale_price = 0
)
clean_resale_data_2017_00 <- bind_rows(clean_resale_data_2017, additional_point)

weights <- ifelse(clean_resale_data_2017_00$remaining_lease == 0, 20509, 1)

weighted_lm_model <- lm(resale_price ~ remaining_lease, data = clean_resale_data_2017_00, weights = weights)

summary(weighted_lm_model)

```

Visualizing on scatter plot,

```{r}
# Scatterplot of data
plot(clean_resale_data_2017_00$remaining_lease, clean_resale_data_2017_00$resale_price, pch = 19, col = "black", main = "Weighted Regression Line: Resale Prices vs. Remaining Lease", xlab = "Remaining Lease (Years)", ylab = "Resale Price (SGD)")

# Add the fitted line from the regression model
abline(weighted_lm_model, col = "red")
```

Price Prediction Data Using Locally estimated scatterplot smoothing,

```{r}
ggplot(clean_resale_data_2017_00, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  geom_smooth(method = "loess") +
  labs(title = "Scatterplot of Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")
```

Price prediction using ggtrendline ##not working, cant combine

```{r}
library(ggtrendline)
ggtrendline(clean_resale_data_2017_00$remaining_lease, clean_resale_data_2017_00$resale_price, model = "line3P")

ggplot(clean_resale_data_2017_00, aes(x = remaining_lease, y = resale_price)) +
  geom_point() +
  labs(title = "Scatterplot of Resale Prices vs. Remaining Lease", x = "Remaining Lease (Years)", y = "Resale Price (SGD)")
```

Prediction of price trend using forecast, ##not working

```{r}
library(forecast)

aggregated_data <- clean_resale_data_2017%>%
  group_by(remaining_lease) %>%
  summarize(avg_resale_price = mean(resale_price))

# Convert data to time series
ts_data <- ts(aggregated_data$avg_resale_price)

# Fit an ARIMA model (replace with your model)
arima_model <- auto.arima(ts_data)

# Make forecasts for years 1 to 41
forecast_values <- forecast(arima_model, h = 41)

# Create a data frame for visualization
df <- data.frame(
  year = 48:96,
  actual = c(0, aggregated_data$avg_resale_price),
  forecast = forecast_values$mean
)

# Create a ggplot to visualize historical and forecasted data
ggplot(df, aes(x = year, y = actual)) +
  geom_line(aes(color = "Actual")) +
  geom_line(aes(x = year, y = forecast, color = "Forecast")) +
  labs(title = "Historical and Forecasted Price Trend", x = "Year", y = "Resale Price") +
  scale_color_manual(values = c("Actual" = "blue", "Forecast" = "red"))

```

Predict trend using least square, ##ugly af, dk how fix

```{r}

additional_point <- data.frame(
  remaining_lease = 0,
  resale_price = 0
)
clean_resale_data_2017_00 <- bind_rows(clean_resale_data_2017, additional_point)

# Define a nonlinear model (you need to choose an appropriate nonlinear function)
polynomial_model <- lm(resale_price ~ remaining_lease + I(remaining_lease^2), 
                      data = clean_resale_data_2017_00)

# Make predictions with the nonlinear model
predictions <- predict(polynomial_model, newdata = data.frame(remaining_lease = 1:99))

# Create a data frame for visualization
df <- data.frame(
  remaining_lease = c(clean_resale_data_2017_00$remaining_lease, 1:99),
  resale_price = c(clean_resale_data_2017_00$resale_price, predictions)
)

# Create a ggplot to visualize the data and nonlinear best-fit line
ggplot(df, aes(x = remaining_lease, y = resale_price)) +
  geom_point(data = clean_resale_data_2017_00, color = "blue") +
  geom_smooth(data = df, aes(x = remaining_lease, y = resale_price), color = "red") +
  labs(title = "Nonlinear Best-Fit Line", x = "Remaining Lease", y = "Resale Price")
```

### Distribution of Price by Storey range of flat

Let's also explore how the storey of the unit affects the price
```{r}
# Since there are too many storeys to display on a barplot, let's create bins
bin_width <- 10 
clean_resale_data_bins <- clean_resale_data %>%
  mutate(storey_bin = cut(avg_storey, breaks = seq(0, max(avg_storey), by = bin_width), right = FALSE))

clean_resale_data_bins <- filter(clean_resale_data_bins, !is.na(storey_bin)) 

storey_bin_summary_stats <- clean_resale_data_bins %>%
  group_by(storey_bin) %>%
  summarize(
    Mean_Price = mean(resale_price),
    Median_Price = median(resale_price),
    Min_Price = min(resale_price),
    Max_Price = max(resale_price)
  )
storey_bin_summary_stats 
```

Visualising using Box Plot,

```{r}
ggplot(clean_resale_data_bins, aes(x = storey_bin, y = resale_price)) +
  geom_boxplot() +
  labs(title = "Distribution of Prices by Storey Range", y = "Resale Price (SGD)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Visualising using a barplot,

```{r}
ggplot(storey_bin_summary_stats, aes(x = storey_bin, y = Mean_Price)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average Price by Storey Range", x = "Storey Range", y = "Average Resale Price (SGD)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Visualizing using a histogram,

```{r}
ggplot(clean_resale_data_bins, aes(x = resale_price)) +
  geom_histogram(binwidth = 50000, fill = "green", color = "black") +
  facet_wrap(~storey_bin, scales = "free") +
  labs(title = "Price Distribution by Storey Range", x = "Resale Price (SGD)") +
  scale_x_continuous(labels = scales::comma)

```
From the above, we can see that there is a general increase in prices for the higher flat units. Looking at the box plot, we can see that there are more outlying data points for the lower storey units. This might indicate that the storey of a unit might not be a very important factor in the resale price as other factors such as location might cause a unit with low storey to be priced highly.

```{r}
ggplot(clean_resale_data, aes(x = month, y = avg_storey)) +
  geom_point() +
  labs(title = "Storey vs. Time", x = "Time", y = "Storey")
```

Furthermore, we must also take note that units with higher storeys typically belong to newer buildings and only have data from more recent years(as seen above) where housing prices are higher. To isolate these other factors to better determine the relationship between storey and resale price, We can filter to only look at recent sales data (2020 onwards) and only look at new HDB units (with 85 or more years of lease remaining).

```{r}
clean_resale_data_bins_2020_onward_new <- clean_resale_data_bins %>%
  filter(year(month) >= 2020 & remaining_lease >= 85)

ggplot(clean_resale_data_bins_2020_onward_new, aes(x = storey_bin, y = resale_price)) +
  geom_boxplot() +
  labs(title = "Distribution of Prices by Storey Range", y = "Resale Price (SGD)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Isolating these factors reduced the average price difference between the higher storey units and lower storey units. However, the trend that the resale price increases with storey still holds.

## Modelling and Prediction of future HDB Resale Prices (xf)

To simplify the linear regression model, we remove some of the variables from the clean_resale_data dataset.
```{r}
clean_resale_data_xf <- clean_resale_data[, !colnames(clean_resale_data) %in% c("block", "street_name", "storey_min", "storey_max", "storey_range", "lease_commence_date")]
colnames(clean_resale_data_xf)
```

Here we split the entire dataset clean_resale_data into both training data (90% data) and test data (10% data).
```{r}
set.seed(123)
train_proportion <- 0.9
total_rows <- nrow(clean_resale_data)
train_size <- round(train_proportion * total_rows)
test_size <- total_rows - train_size
sample_index <- sample(1:total_rows, total_rows)
train_data <- clean_resale_data[sample_index[1:train_size], ]
test_data <- clean_resale_data[sample_index[(train_size + 1):total_rows], ]

summary(train_data)

```
```{r}
clean_resale_data$month <- as.numeric(as.Date(clean_resale_data$month))
```

Next we create a linear regression model with 2 input variables - town and flat_type.
```{r}
lm_model_twov <- lm(resale_price ~ town + flat_type, data = train_data)
summary(lm_model_twov)

```

We test the accuracy of the linear regression model using test_data:
```{r}
predictions <- predict(lm_model_twov, newdata = test_data)
actual_values <- test_data$resale_price
mae <- mean(abs(predictions - actual_values))
mse <- mean((predictions - actual_values)^2)
rmse <- sqrt(mse)
cat("Mean Absolute Error (MAE): ", mae, "\n")
cat("Mean Squared Error (MSE): ", mse, "\n")
cat("Root Mean Squared Error (RMSE): ", rmse, "\n")

```

```{r}
# Try the 2 variable linear regression using 2 continuous variables
lm_model_twov2 <- lm(resale_price ~  floor_area_sqm + remaining_lease, data = train_data)
summary(lm_model_twov2)
```
```{r}
predictions <- predict(lm_model_twov2, newdata = test_data)
actual_values <- test_data$resale_price
mae <- mean(abs(predictions - actual_values))
mse <- mean((predictions - actual_values)^2)
rmse <- sqrt(mse)
cat("Mean Absolute Error (MAE): ", mae, "\n")
cat("Mean Squared Error (MSE): ", mse, "\n")
cat("Root Mean Squared Error (RMSE): ", rmse, "\n")
```


Next, we train the linear regression model using all the variables. 
```{r}
lm_model_allv <- lm(resale_price ~ month + town + flat_type + floor_area_sqm + remaining_lease + avg_storey, data = train_data)
summary(lm_model_allv)
```

We test the accuracy of this model:
```{r}
predictions <- predict(lm_model_allv, newdata = test_data)
actual_values <- test_data$resale_price
mae <- mean(abs(predictions - actual_values))
mse <- mean((predictions - actual_values)^2)
rmse <- sqrt(mse)
cat("Mean Absolute Error (MAE): ", mae, "\n")
cat("Mean Squared Error (MSE): ", mse, "\n")
cat("Root Mean Squared Error (RMSE): ", rmse, "\n")
```
```{r}
colnames(clean_resale_data)
str(clean_resale_data)
```








K Nearest Neighbour
```{r}
# Convert the discreet variables into factors
clean_resale_data$town <- as.factor(clean_resale_data$town)
clean_resale_data$flat_type <- as.factor(clean_resale_data$flat_type)

# Convert the 'month' variable which is a Date class to numeric:
clean_resale_data$month <- as.numeric(as.Date(clean_resale_data$month))
str(clean_resale_data)

# Scale the continuous (numeric) variables
clean_resale_data$floor_area_sqm <- scale(clean_resale_data$floor_area_sqm)
clean_resale_data$resale_price <- scale(clean_resale_data$resale_price)
clean_resale_data$remaining_lease <- scale(clean_resale_data$remaining_lease)
clean_resale_data$avg_storey <- scale(clean_resale_data$avg_storey)
clean_resale_data$month <- scale(clean_resale_data$month)

# Split the dataset into training and testing set 
set.seed(123)
total_rows <- nrow(clean_resale_data)
train_size <- round(0.9 * total_rows)  # 90% of the data goes to the training set
test_size <- total_rows - train_size   # Rest of the data goes to the test set
train_indices <- sample(1:total_rows, train_size)
train_data <- clean_resale_data[train_indices, ]
test_data <- clean_resale_data[-train_indices, ]

#predictors <- c('town', 'flat_type', 'floor_area_sqm', 'remaining_lease', 'avg_storey','month') 
predictors <- c('floor_area_sqm', 'remaining_lease', 'avg_storey','month') 
target <- 'resale_price' 

# Train the KNN model
knn_model <- knn(train = train_data[, predictors], test = test_data[, predictors], cl = train_data[, target], k = 1)

# Test the test data set

predictions <- knn_model

# Extract the actual target values from the test dataset
actual_values <- test_data[, ]

# Calculate RMSE
rmse <- sqrt(mean((predictions - actual_values)^2))

# Print RMSE
print(paste("Root Mean Squared Error (RMSE):", rmse))


#print(unique(clean_resale_data$month))
#summary(clean_resale_data)
print(sum(is.na(clean_resale_data$month)))
print(sum(is.na(clean_resale_data$floor_area_sqm)))
print(sum(is.na(clean_resale_data$resale_price)))
print(sum(is.na(clean_resale_data$remaining_lease)))
print(sum(is.na(clean_resale_data$avg_storey)))
print(sum(is.na(clean_resale_data$town)))
print(sum(is.na(clean_resale_data$flat_type)))

any(is.infinite(clean_resale_data$remaining_lease))
any(is.infinite(clean_resale_data$avg_storey))
any(is.infinite(clean_resale_data$month))
any(is.infinite(clean_resale_data$floor_area_sqm))
any(is.infinite(clean_resale_data$resale_price))
any(is.infinite(clean_resale_data$town))
any(is.infinite(clean_resale_data$flat_type))

dim(train_data[, predictors])
dim(test_data[, predictors])
dim(train_data[, target])


#knn_model <- knn(train = train_data[, predictors], test = test_data[, predictors], cl = train_data[, target], k = 3)
```
```{r}
str(clean_resale_data)
```


```{r}
library(caret)
library(class)

# Convert discreet variables into factors
train_data$discrete_var <- as.factor(train_data$discrete_var)

```


## How BTO Buyers can maximise returns (KIV)

HDB BTO (Build-To-Order) flats are a type of public housing in Singapore, offered by the Housing and Development Board (HDB). These flats are designed to cater to the housing needs of Singaporean citizens and are typically more affordable than private housing options.

The Minimum Occupancy Period (MOP) is the minimum duration that homeowners are required to occupy their BTO flats before they can sell or rent them. The MOP duration typically ranges from 5 to 10 years, depending on the flat type and whether the flat was bought under the singles scheme. For example, the MOP for a standard family nucleus in a 4-room flat is typically 5 years.

```{r}
BTO_data <- read_csv("BTO.csv")

BTO_town_counts <- count(BTO_data ,BTO_data$town)
BTO_data
BTO_town_counts
```

We will select only projects with more than 20 BTO launches in this dataset, to make sure our data and analysis are significant. We will also remove rows where the selling price is 0, meaning to say that there was no launch of that room-type in the town.

```{r}
BTO_data_merged <- merge(BTO_data ,BTO_town_counts, by.x = "town", by.y = "BTO_data$town")
  
BTO_data_filtered <- filter(BTO_data_merged ,BTO_data_merged$n > 20)

BTO_data_final <- filter(BTO_data_filtered, BTO_data_filtered$min_selling_price > 0)
```

Next, we further clean this data to make sure that the columns of town and room-types and their corresponding values match that of the clean_resale_data figures.

```{r}
BTO_data_final$town_upper = toupper(BTO_data_final$town)

mapping <- c("2-room" = "2 ROOM", "3-room" = "3 ROOM", "4-room" = "4 ROOM", "5-room" = "5 ROOM")

BTO_data_final <- BTO_data_final %>%
  mutate(flat_type = case_when(
    room_type %in% names(mapping) ~ mapping[room_type],
    TRUE ~ NA_character_
  ))

BTO_data_final
count(BTO_data_final, BTO_data_final$flat_type)

```

Since BTOs have a minimum occupancy period of 5 years, and the earliest BTO project we have in the data set is in 2008, we will only require resale prices from year 2013 onwards, and we do the filtering. Next, we got the mean resale price for each town, flat type and year from clean_resale_data, to be merged later on with BTO_data_final.

```{r}
resale_data_for_bto <- clean_resale_data %>%
  mutate(year = year(month)) %>%
  group_by(year, town, flat_type) %>%
  filter(town %in% c("CHOA CHU KANG", "PUNGGOL", "SEMBAWANG", "SENGKANG", "WOODLANDS", "YISHUN")) %>%
  filter(year >= 2013) %>%
  summarise(mean_resale_price = mean(resale_price))

resale_data_for_bto

```

We want to see what the mean resale price of each BTO listing, every year after the MOP is up (assuming that the MOP is 5 years for all of these BTO projects). We look 10 years after the MOP is up, and add 10 columns for every row to the BTO_final_data. We then populate these columns by checking for the year, town and room-type data and getting the mean_resale_price value from resale_data_for_bto:

```{r}
for (i in 1:10) {
  column_name <- paste("Mean Resale Price ", i, " years after the MOP")
  
  mean_resale_price_values <- numeric(nrow(BTO_data_final))
  
  for (j in 1:nrow(BTO_data_final)) {
    year_condition <- BTO_data_final$financial_year[j] + i + 5 == (resale_data_for_bto$year) &
                     BTO_data_final$town_upper[j] == resale_data_for_bto$town &
                    BTO_data_final$flat_type[j] == resale_data_for_bto$flat_type
    if (any(year_condition)) {
      mean_resale_price_values[j] <- (resale_data_for_bto$mean_resale_price[year_condition])
    } else {
      mean_resale_price_values[j] <- NA
    }
  }
  
  BTO_data_final[[column_name]] <- mean_resale_price_values
}

view(BTO_data_final)

BTO_data_final
```

Calculate returns based on:

### Number of years after minimum MOP

In this section, we want to find out if there is an optimal time for BTO owners to sell their flats to the public market in order to maximize profits from the sale.

We only have full 10 years of data from BTO projects launched in 2008: Punggol, Sengkang and Woodlands. We will also standardise the flat-type to 4-rooms, and use those as our data for this study.

```{r}
rows_years <- subset(BTO_data_final, financial_year == 2008 & flat_type == "4 ROOM")

rows_years
```

We will then calculate the potential profit in each year after the MOP is up. To standardize the purchase price, we will take the mean between the min_selling_price and max_selling_price.

```{r}
profit_over_years <- rows_years %>%
  mutate(mean_purchase_price = (min_selling_price + max_selling_price) / 2) %>%
  rename_with(~ str_replace_all(., "Price", "Profit"), -mean_purchase_price)

profit_over_years

# Define the column from which you want to subtract values
columns_to_deduct_from <- c("Mean Resale Profit  1  years after the MOP"
, "Mean Resale Profit  2  years after the MOP"
, "Mean Resale Profit  3  years after the MOP"
, "Mean Resale Profit  4  years after the MOP"
, "Mean Resale Profit  5  years after the MOP"
, "Mean Resale Profit  6  years after the MOP"
, "Mean Resale Profit  7  years after the MOP"
, "Mean Resale Profit  8  years after the MOP"
, "Mean Resale Profit  9  years after the MOP"
, "Mean Resale Profit  10  years after the MOP")

# Iterate through columns and subtract values
for (col_name in colnames(profit_over_years)) {
  if (col_name %in% columns_to_deduct_from) {
    profit_over_years <- profit_over_years %>%
      mutate(!!col_name := as.numeric(profit_over_years[ , col_name]) - mean_purchase_price)
  }
}

view(profit_over_years)
```

```{r}
profit_over_years %>%
  select(-town, -financial_year, -room_type, -min_selling_price_less_ahg_shg, -max_selling_price, -min_selling_price, -max_selling_price_less_ahg_shg, -n, -town_upper, -flat_type, -room_type, -mean_purchase_price)
  
```

```{r}
# Plot a line graph for each row
for (i in 1:nrow(profit_over_years)) {
  data_row <- profit_over_years[i, -1]  # Exclude the ID column
  data_row <- data.frame(Year = names(data_row), Value = as.numeric(data_row))
  
  # Create a line plot
  p <- ggplot(data_row, aes(x = Year, y = Value)) +
    geom_line() +
    labs(title = paste("Row", i))
  
  print(p)
}
```

-   Town

-   Room Type
